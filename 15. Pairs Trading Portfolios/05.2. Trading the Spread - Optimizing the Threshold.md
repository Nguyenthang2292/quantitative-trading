***Bản quyền dịch thuật và diễn giải thuộc về justinnguyen92&copy; - [telegram](https://t.me/justinnguyen92)***

# Optimizing the Threshold
Xem xét chiến lược **thresholded strategy** đơn giản, trong đó:
- **Mua:** Khi **Z-score** giảm xuống dưới ngưỡng $$-s_0$$.
- **Bán khống:** Khi **Z-score** vượt lên trên ngưỡng $$+s_0$$.
- **Đóng vị thế (unwinding):** Khi **Z-score** quay trở lại giá trị cân bằng (zero).

Lưu ý rằng, theo ngữ cảnh của *spread*, ngưỡng $$s_0$$ được định nghĩa là:

$$s_0 \times \sigma$$

**Trong đó:**
- $$\sigma$$: Độ lệch chuẩn của *spread*.

Việc lựa chọn giá trị ngưỡng $$s_0$$ là rất quan trọng vì nó xác định:
1. **Tần suất vị thế được đóng (chốt lời).**
2. **Lợi nhuận tối thiểu đạt được trên mỗi giao dịch.**

Tổng lợi nhuận bằng số lần giao dịch nhân với lợi nhuận của mỗi giao dịch. Khi vị thế được đóng sau $$k$$ kỳ, ý nghĩa của sự khác biệt *spread* $$z_{t+k} - z_t$$ phụ thuộc vào việc *spread* biểu thị **log-prices** hay **prices**:
- **Log-prices:** Chênh lệch *spread* biểu thị log-return (lợi nhuận log).
- **Prices:** Chênh lệch *spread* biểu thị lợi nhuận tuyệt đối (*absolute profit*).

Do đó, sau $$N_{trades}$$ giao dịch thành công, tổng lợi nhuận (chưa gộp lãi) có thể được tính là:

$$N_{trades} \times s_0 \times \sigma$$

(Lợi nhuận gộp lãi - *compounded profit* cũng có thể được sử dụng).

Phần tiếp theo sẽ xác định giá trị ngưỡng tối ưu $$s_0$$ để tối đa hóa tổng lợi nhuận trong cả hai cách tiếp cận tham số và phi tham số.

### Diễn giải chi tiết:
1. **Ngưỡng giao dịch $$(s_0$$):**
   - Ngưỡng $$s_0$$ được sử dụng để xác định mức độ phân kỳ cần thiết trước khi thực hiện giao dịch.
   - Ngưỡng này là thước đo độ nhạy của chiến lược:
     - **Ngưỡng nhỏ** → Giao dịch thường xuyên hơn, nhưng lợi nhuận mỗi giao dịch thấp.
     - **Ngưỡng lớn** → Giao dịch ít hơn, nhưng lợi nhuận mỗi giao dịch cao hơn.

2. **Ý nghĩa của *spread*:**
   - Nếu *spread* được đo bằng log-prices, chênh lệch *spread* đại diện cho lợi nhuận log (*log-return*).
   - Nếu *spread* được đo bằng prices, chênh lệch *spread* đại diện cho lợi nhuận tuyệt đối (*absolute profit*).

3. **Tổng lợi nhuận:**
   - Lợi nhuận tổng hợp là sản phẩm của:
     - **Số lần giao dịch thành công** $$(N_{trades}$$).
     - **Lợi nhuận tối thiểu của mỗi giao dịch** $$(s_0 \cdot \sigma$$).

4. **Mục tiêu:**
   - Xác định giá trị tối ưu của $$s_0$$ để cân bằng giữa tần suất giao dịch và lợi nhuận mỗi giao dịch nhằm tối đa hóa tổng lợi nhuận.

## Kết luận:
- Chiến lược **thresholded strategy** phụ thuộc vào việc lựa chọn ngưỡng $$s_0$$, giúp tối ưu hóa lợi nhuận dựa trên mức độ phân kỳ và hồi quy của *spread*.
- Trong thực tế, giá trị $$s_0$$ phải được điều chỉnh phù hợp với dữ liệu lịch sử và điều kiện thị trường cụ thể để đạt hiệu quả cao nhất.

# Parametric Approach
Giả sử *Z-score* tuân theo phân phối chuẩn chuẩn hóa:

$$z_{score} \sim \mathcal{N}(0, 1)$$

Khi đó, xác suất *Z-score* lệch khỏi giá trị trung bình 0 với biên độ lớn hơn hoặc bằng $$s_0$$ là:

$$1 - \Phi(s_0)$$

**Trong đó:**
- $$\Phi(\cdot)$$: Hàm phân phối tích lũy (CDF) của phân phối chuẩn.

Với chuỗi thời gian có $$T$$ giai đoạn, số sự kiện giao dịch khả thi (theo một hướng) có thể được xấp xỉ:

$$T \times \left(1 - \Phi(s_0)\right)$$

**Lợi nhuận tổng thể là:**

$$T \times \left(1 - \Phi(s_0)\right) \times s_0$$

Dưới mô hình tham số đơn giản này, ngưỡng tối ưu $$s_0^*$$ có thể được tìm thấy bằng cách:

$$s_0^* = \arg \max_{s_0} \left[(1 - \Phi(s_0)) \cdot s_0 \right]$$

Hình 15.15 minh họa cách đánh giá tham số của lợi nhuận so với ngưỡng $$s_0$$ cho một chuỗi *spread* Gaussian tổng hợp.
![image](https://github.com/user-attachments/assets/b73faef1-f494-4142-a284-b47191dad55c)

## Diễn giải chi tiết:
1. **Giả định về *Z-score*:**
   - *Z-score* được giả định tuân theo phân phối chuẩn chuẩn hóa $$\mathcal{N}(0, 1)$$, điều này phù hợp với thực tế vì *Z-score* là sự chuẩn hóa của *spread* dựa trên trung bình và phương sai.

2. **Xác suất giao dịch:**
   - Xác suất *Z-score* vượt qua ngưỡng $$s_0$$ (trong một hướng, tức là chỉ giao dịch mua hoặc bán) là:

$$1 - \Phi(s_0)$$

   - Do đó, số sự kiện giao dịch có thể xảy ra trong chuỗi thời gian $$T$$ là:

$$T \times (1 - \Phi(s_0))$$

3. **Lợi nhuận tổng thể:**
   - Lợi nhuận mỗi giao dịch tối thiểu là $$s_0$$.
   - Lợi nhuận tổng thể (chưa gộp lãi) là:
     
$$T \times (1 - \Phi(s_0)) \times s_0$$

   - Công thức này thể hiện rằng lợi nhuận phụ thuộc vào ngưỡng $$s_0$$:
     - Ngưỡng $$s_0$$ lớn hơn → ít giao dịch nhưng lợi nhuận mỗi giao dịch cao hơn.
     - Ngưỡng $$s_0$$ nhỏ hơn → nhiều giao dịch nhưng lợi nhuận mỗi giao dịch thấp hơn.

4. **Ngưỡng tối ưu ($$s_0^*$$):**
   - Ngưỡng tối ưu $$s_0^*$$ được xác định bằng cách tối đa hóa hàm lợi nhuận tổng thể:

$$s_0^* = \arg \max_{s_0} \left[(1 - \Phi(s_0)) \cdot s_0 \right]$$

## Kết luận:
- **Parametric Approach:** Cung cấp cách tiếp cận có hệ thống để tối ưu hóa ngưỡng giao dịch $$s_0$$, dựa trên giả định về phân phối của *Z-score*.
- **Ứng dụng thực tế:** Giá trị $$s_0^*$$ sẽ tối ưu hóa sự cân bằng giữa tần suất giao dịch và lợi nhuận mỗi giao dịch, giúp tối đa hóa tổng lợi nhuận.
- **Hạn chế:** Phương pháp này giả định phân phối chuẩn của *Z-score*, có thể không hoàn toàn đúng với dữ liệu thực tế.

# Nonparametric Data-Driven Approach
Một phương pháp thay thế cho cách tiếp cận tham số *(parametric approach)* là phương pháp dựa trên dữ liệu phi tham số *(nonparametric data-driven approach)*. Phương pháp này không dựa vào bất kỳ giả định mô hình nào. Ý tưởng chính là sử dụng dữ liệu sẵn có để thực nghiệm tính toán số lượng sự kiện giao dịch cho mỗi ngưỡng có thể.

Cho $$T$$ quan sát của *Z-score*, $$z_t^{score}$$, và $$J$$ giá trị ngưỡng được phân rời, $$s_{0,1}, \dots, s_{0,J}$$, ta có thể tính toán tần suất giao dịch thực nghiệm cho mỗi ngưỡng $$s_{0,j}$$ (theo một hướng) như sau:

$$f_j = \frac{1}{T} \sum_{t=1}^T \mathbf{1}\{z_t^{score} > s_{0,j}\}$$

Trong đó:
- $$\mathbf{1}\{\}$$ là hàm chỉ báo, trả về giá trị 1 nếu điều kiện đúng và 0 nếu sai.

Tuy nhiên, các giá trị thực nghiệm $$f_j$$ có thể rất nhiều *noise*, điều này có thể ảnh hưởng đến việc đánh giá tổng lợi nhuận. Một cách để giảm nhiễu trong các giá trị này là tăng tính trơn và giảm sự dao động giữa các giá trị liên tiếp. Chúng ta có thể tìm một phiên bản mượt hơn bằng cách giải bài toán **bình phương tối thiểu** *(least squares)*:

$$\min_f \sum_{j=1}^J (f_j - \bar{f_j})^2 + \lambda \sum_{j=1}^{J-1} (f_j - f_{j+1})^2$$

Trong đó:
- Thành phần đầu tiên đo lường sự khác biệt giữa giá trị $$f_j$$ nhiều và giá trị mượt.
- Thành phần thứ hai đảm bảo tính mượt mà, được kiểm soát bởi siêu tham số $$\lambda$$.

Bài toán này có thể viết gọn hơn dưới dạng:

$$\min_f \|f - \bar{f}\|_2^2 + \lambda \|D f\|_2^2$$

Trong đó:
- $$D$$ là ma trận sai phân (*difference matrix*), được định nghĩa như sau:

```math
D =
\begin{bmatrix}
1 & -1 & 0 & \cdots & 0 \\
0 & 1 & -1 & \cdots & 0 \\
\vdots & \vdots & \vdots & \ddots & \vdots \\
0 & 0 & 0 & \cdots & -1
\end{bmatrix}
\in \mathbb{R}^{(J-1) \times J}
```

Do đây là bài toán bình phương tối thiểu, lời giải có dạng đóng (*closed-form*):

$$f^* = (I + \lambda D^\top D)^{-1} \bar{f}$$

Cuối cùng, ngưỡng tối ưu có thể được tìm bằng cách tối đa hóa tổng lợi nhuận đã được làm mượt:

$$s_{0,j}^* = \arg \max_{s_{0,j}} f_j$$

Hình 15.16 minh họa việc đánh giá phi tham số về lợi nhuận so với ngưỡng, cho thấy phiên bản dữ liệu mượt hơn và ít nhiễu gốc.
![image](https://github.com/user-attachments/assets/6e80b7fa-5c12-4b87-a470-ec0788d29991)

### Diễn giải chi tiết:
1. **Phương pháp phi tham số**:
   - Không giả định *Z-score* tuân theo phân phối chuẩn, mà chỉ sử dụng dữ liệu thực nghiệm.
   - Tính toán tần suất giao dịch thực nghiệm $$f_j$$ cho mỗi ngưỡng $$s_{0,j}$$.

2. **Giảm nhiễu**:
   - Các giá trị $$f_j$$ thực nghiệm có thể bị nhiễu (do số lượng giao dịch nhỏ hoặc sự biến động bất thường).
   - Sử dụng bài toán bình phương tối thiểu để mượt hóa $$f_j$$, đảm bảo tính liên tục giữa các ngưỡng.

3. **Bài toán mượt hóa**:
   - Thành phần $$\|f - \bar{f}\|_2^2$$: Đo độ lệch giữa giá trị nhiễu và giá trị mượt.
   - Thành phần $$\|D f\|_2^2$$: Đảm bảo sự thay đổi giữa các giá trị $$f_j$$ liên tiếp là nhỏ, duy trì tính mượt mà.

4. **Ngưỡng tối ưu**:
   - Ngưỡng tối ưu $$s_{0,j}^*$$ được xác định bằng cách tối đa hóa tổng lợi nhuận trên dữ liệu mượt.

### Kết luận:
- Phương pháp phi tham số không dựa vào giả định mô hình, giúp linh hoạt và phù hợp với dữ liệu thực nghiệm.
- Mượt hóa tần suất giao dịch $$f_j$$ giúp cải thiện đánh giá lợi nhuận và xác định ngưỡng giao dịch tối ưu $$s_{0}^*$$.
- Đây là cách tiếp cận mạnh mẽ khi dữ liệu nhiễu và không đáp ứng được các giả định mô hình của phương pháp tham số.

# Numerical Experiments
Bây giờ, chúng ta sẽ thực hiện giao dịch cặp với dữ liệu thị trường từ năm 2013 đến năm 2022. Hai năm đầu tiên được sử dụng để ước tính hệ số phòng hộ $$\gamma$$, yếu tố quan trọng để hình thành *spread*. Sau đó, *spread* được giao dịch trên khoảng thời gian còn lại ngoài mẫu. *Z-score* được tính toán trên cơ sở cửa sổ trượt (như trong Bollinger Bands) để đảm bảo rằng nó thích ứng với các thay đổi của thị trường theo thời gian và duy trì đặc tính hồi quy về trung bình. Để giao dịch *spread*, chiến lược **Thresholded Strategy** được sử dụng (chiến lược tuyến tính có thể được áp dụng với kết quả tương tự). Để đơn giản, ngưỡng $$s_0$$ được đặt là 1; tất nhiên, người dùng có thể chọn các giá trị khác, nhưng cần thận trọng để tránh thiên lệch dự đoán (look-ahead bias) và việc tối ưu hóa quá mức (xem Chương 8 để biết thêm về các nguy cơ của việc backtesting và tối ưu hóa siêu tham số).

### Dữ liệu thị trường: EWA và EWC
Chúng ta bắt đầu với hai ETF, EWA và EWC, lần lượt theo dõi hiệu suất của các nền kinh tế Úc và Canada. Như đã kiểm tra trong Mục 15.4, hầu hết các kiểm định cho thấy cointegration tồn tại trong phần lớn thời kỳ, mặc dù đôi khi nó có thể bị mất. *Z-score* được tính trên cơ sở cửa sổ trượt với khoảng thời gian quay lại là sáu tháng.

Hình 15.17 cho thấy *spread* (với hệ số phòng hộ $$\gamma$$ được ước tính thông qua phương pháp bình phương nhỏ nhất trong hai năm đầu tiên), *Z-score*, tín hiệu giao dịch và lợi nhuận tích lũy. Chúng ta có thể quan sát rằng *spread* không cho thấy một mối quan hệ cointegration mạnh mẽ và liên tục trên toàn bộ thời kỳ; trên thực tế, hệ số phòng hộ và trạng thái của cointegration thay đổi theo thời gian. *Z-score* có khả năng tạo ra một phiên bản hồi quy về trung bình ổn định hơn nhờ vào sự thích ứng của cửa sổ trượt.

Trong mọi trường hợp, bất kỳ việc triển khai giao dịch cặp thực tế nào cũng sẽ tính toán lại hệ số phòng hộ $$\gamma$$, như được giả định trong phần phân tích của các thí nghiệm với phương pháp cửa sổ trượt.
Hình 15.18 cho thấy kết quả khi hệ số phòng hộ $$\gamma$$ được tính toán trên cơ sở cửa sổ trượt với thời gian quay lại là hai năm. Chúng ta có thể thấy rằng spread đã được cải thiện so với phương pháp bình phương nhỏ nhất cố định trước đó và trông có vẻ hồi quy về trung bình tốt hơn. Tuy nhiên, *z-score* vẫn có thể được cải thiện hơn nữa để tạo ra một phiên bản hồi quy về trung bình tốt hơn. Lợi nhuận tích lũy cho thấy sự cải thiện nhờ phương pháp bình phương nhỏ nhất theo cửa sổ trượt; tuy nhiên, tốt hơn hết là sử dụng bộ lọc Kalman như được khám phá trong Mục 15.6.

Figure 15.17: Pairs trading on EWA–EWC with six-month rolling z-score and two-year fixed least squares.
![image](https://github.com/user-attachments/assets/df3a113d-b8d6-425e-9bea-1534f487cac7)

Figure 15.18: Pairs trading on EWA–EWC with six-month rolling z-score and two-year rolling least squares.
![image](https://github.com/user-attachments/assets/3600fa88-f0d7-4301-a761-a15e8255a95a)

Ý chính:
- Sử dụng phương pháp cửa sổ trượt để thích ứng với thay đổi của thị trường.
- Kết quả cho thấy các cải tiến đáng kể khi sử dụng cửa sổ trượt hai năm để tính toán hệ số phòng hộ.
- Bộ lọc Kalman được khuyến nghị để cải thiện thêm việc ước tính spread và hiệu suất giao dịch.

## Dữ liệu Thị trường: KO và PEP
Chúng tôi tiếp tục thử nghiệm giao dịch cặp trên các cổ phiếu của Coca-Cola (KO) và Pepsi (PEP), vốn dường như không có mối quan hệ cointegration theo các thử nghiệm trước đó trong Mục 15.4. Để thực tế hơn, hệ số phòng hộ $$\gamma$$ được ước tính bằng phương pháp bình phương nhỏ nhất theo cửa sổ trượt với thời gian quay lại là hai năm (điều này có thể giúp thích ứng với thay đổi của mối quan hệ cointegration). Z-score được tính toán trên cơ sở cửa sổ trượt với thời gian quay lại là sáu tháng (và một tháng để thích nghi nhanh hơn).

Hình 15.19 cho thấy spread, z-score, tín hiệu giao dịch và lợi nhuận tích lũy. Chúng ta có thể quan sát rằng spread mất đi đặc tính hồi quy về trung bình mặc dù việc tính toán hệ số phòng hộ theo cửa sổ trượt. Z-score có thể tạo ra một phiên bản hồi quy về trung bình ổn định hơn nếu tiếp tục quan sát thay các đột biến, cho thấy sự mất mát của cointegration. Lợi nhuận tích lũy chỉ ra rằng việc giao dịch không thành công lắm.

Hình 15.20 cho thấy kết quả khi z-score được tính toán với khả năng thích ứng nhanh hơn, sử dụng thời gian quay lại là một tháng (so với sáu tháng trước đó). Z-score trông tốt hơn nhiều, với sự hồi quy về trung bình mạnh hơn. Điều này chuyển thành tần suất giao dịch cao hơn (so sánh tần suất tín hiệu giao dịch), nhưng lợi nhuận tích lũy vẫn không cho thấy khả năng sinh lời đáng kể.

Figure 15.19: Pairs trading on KO–PEP with six-month rolling z-score and two-year rolling least squares.
![image](https://github.com/user-attachments/assets/88025892-c3ef-4ae6-96b3-c6ca4948f3a1)

Figure 15.20: Pairs trading on KO–PEP with one-month rolling z-score and two-year rolling least squares.
![image](https://github.com/user-attachments/assets/02af29b1-d692-4301-9e93-6e6befc0c65f)

Ý chính:
1. Thử nghiệm với KO và PEP:
- Không có mối quan hệ cointegration rõ ràng giữa hai cổ phiếu này.
- Hệ số phòng hộ được tính toán trên cơ sở cửa sổ trượt để thích nghi với sự thay đổi trong quan hệ giữa hai tài sản.

2. Kết quả:
- Với cửa sổ trượt sáu tháng:
   - Spread mất đặc tính hồi quy về trung bình.
   - Z-score vẫn có các đột biến, cho thấy sự mất mát của cointegration.
   - Giao dịch không mang lại lợi nhuận đáng kể.
- Với cửa sổ trượt một tháng:
   - Z-score cải thiện, hồi quy về trung bình mạnh hơn.
   - Tần suất giao dịch tăng, nhưng lợi nhuận tích lũy vẫn không đạt được kết quả tốt.
3. Nhận xét:
- Dữ liệu cho thấy việc sử dụng cặp KO và PEP không hiệu quả cho chiến lược giao dịch dựa trên hồi quy về trung bình, dù đã thử các cửa sổ trượt khác nhau.
