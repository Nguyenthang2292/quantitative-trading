## 1. Pairs Trading cÃ³ lá»£i nhuáº­n khÃ´ng?
*Pairs trading* dá»±a trÃªn giáº£ Ä‘á»‹nh ráº±ng má»‘i quan há»‡ lá»‹ch sá»­ giá»¯a hai cÃ´ng cá»¥ tÃ i chÃ­nh sáº½ Ä‘Æ°á»£c duy trÃ¬ trong tÆ°Æ¡ng lai. Tuy nhiÃªn, Ä‘iá»u nÃ y khÃ´ng pháº£i lÃºc nÃ o cÅ©ng Ä‘Ãºng vÃ¬ má»‘i quan há»‡ *cointegration* cÃ³ thá»ƒ thay Ä‘á»•i theo thá»i gian do nhiá»u yáº¿u tá»‘ nhÆ°:

- Äiá»u kiá»‡n thá»‹ trÆ°á»ng.
- Xu hÆ°á»›ng ngÃ nh.
- Sá»± kiá»‡n cá»¥ thá»ƒ liÃªn quan Ä‘áº¿n cÃ´ng ty.
Do Ä‘Ã³, *pairs trading* tiá»m áº©n rá»§i ro vÃ  yÃªu cáº§u nhÃ  giao dá»‹ch pháº£i giÃ¡m sÃ¡t cháº·t cháº½ má»‘i quan há»‡ giá»¯a cÃ¡c cÃ´ng cá»¥, cÅ©ng nhÆ° sá»­ dá»¥ng cÃ¡c ká»¹ thuáº­t quáº£n lÃ½ rá»§i ro Ä‘á»ƒ báº£o vá»‡ vá»‹ tháº¿ giao dá»‹ch cá»§a mÃ¬nh.

Má»™t sá»‘ nghiÃªn cá»©u cho tháº¥y *pairs trading* cÃ³ thá»ƒ táº¡o ra lá»£i nhuáº­n *(Avellaneda & Lee, 2010; Elliott et al., 2005; Gatev et al., 2006)*, trong khi nhá»¯ng nghiÃªn cá»©u khÃ¡c cho ráº±ng má»‘i quan há»‡ cointegration khÃ´ng Ä‘Æ°á»£c duy trÃ¬ á»•n Ä‘á»‹nh theo thá»i gian *(Chan, 2013; Clegg, 2014)*.

## Nhá»¯ng cáº£nh bÃ¡o khi sá»­ dá»¥ng *Pairs Trading*:
1. Chi phÃ­ giao dá»‹ch:
 - PhÃ­ giao dá»‹ch cÃ³ thá»ƒ lá»›n hÆ¡n cáº£ lá»£i nhuáº­n kiáº¿m Ä‘Æ°á»£c tá»« *spread*.

2. Hiá»‡u quáº£ giáº£m dáº§n:
 - Má»™t chiáº¿n lÆ°á»£c tá»«ng hiá»‡u quáº£ trong quÃ¡ khá»© cÃ³ thá»ƒ khÃ´ng cÃ²n hiá»‡u quáº£ trong thá»i gian gáº§n Ä‘Ã¢y.

3. KhÃ³ khÄƒn ká»¹ thuáº­t:
 - Thanh khoáº£n tháº¥p khi bÃ¡n khá»‘ng.
 - Nguy cÆ¡ *margin call* (bá»‹ yÃªu cáº§u bá»• sung kÃ½ quá»¹ khi giÃ¡ biáº¿n Ä‘á»™ng báº¥t lá»£i).
 - Cáº¡nh tranh giá»¯a cÃ¡c nhÃ  giao dá»‹ch táº§n suáº¥t cao.

## Giáº£i phÃ¡p:
- Sá»­ dá»¥ng lá»c Kalman *(Kalman Filter)* Ä‘á»ƒ Æ°á»›c tÃ­nh má»™t má»‘i quan há»‡ *cointegration* thay Ä‘á»•i theo thá»i gian.
- Sá»­ dá»¥ng mÃ´ hÃ¬nh **VECM** *(Vector Error Correction Model)* Ä‘á»ƒ kháº¯c phá»¥c cÃ¡c háº¡n cháº¿ vá» *cointegration*.

## 2. Thiáº¿t káº¿ Pairs Trading
Pháº§n nÃ y giá»›i thiá»‡u chi tiáº¿t vá» thiáº¿t káº¿ chiáº¿n lÆ°á»£c pairs trading. Má»¥c tiÃªu cá»§a chiáº¿n lÆ°á»£c lÃ  giao dá»‹ch má»™t *spread* há»“i quy vá» trung bÃ¬nh cÃ³ lá»£i nhuáº­n, bao gá»“m cÃ¡c bÆ°á»›c chÃ­nh nhÆ°:
1. XÃ¡c Ä‘á»‹nh cáº·p tÃ i sáº£n cÃ³ quan há»‡ *cointegration*:
- Tá»« cÃ¡c bÆ°á»›c sÃ ng lá»c cÆ¡ báº£n Ä‘áº¿n cÃ¡c kiá»ƒm tra thá»‘ng kÃª phá»©c táº¡p.
2. Thiáº¿t káº¿ chiáº¿n lÆ°á»£c giao dá»‹ch:
- Dá»±a trÃªn viá»‡c lá»±a chá»n ngÆ°á»¡ng $$ð‘ _0$$ hoáº·c sá»­ dá»¥ng cÃ¡c phÆ°Æ¡ng phÃ¡p phá»©c táº¡p hÆ¡n.

**CÃ¡c phÆ°Æ¡ng phÃ¡p nÃ¢ng cao:**
- Lá»c *Kalman*: DÃ¹ng Ä‘á»ƒ Æ°á»›c tÃ­nh má»™t má»‘i quan há»‡ *cointegration* thay Ä‘á»•i theo thá»i gian.
- Má»Ÿ rá»™ng *pairs trading*: Ãp dá»¥ng chiáº¿n lÆ°á»£c nÃ y cho hÆ¡n hai tÃ i sáº£n.

## 3. Pre-screening (SÃ ng lá»c sÆ¡ bá»™)
### 1. Tá»•ng quan vá» Prescreening:
SÃ ng lá»c sÆ¡ bá»™ (*pre-screening*) lÃ  má»™t quÃ¡ trÃ¬nh Ä‘Æ¡n giáº£n vÃ  tiáº¿t kiá»‡m chi phÃ­, trong Ä‘Ã³ nhiá»u cáº·p tÃ i sáº£n cÃ³ thá»ƒ Ä‘Æ°á»£c loáº¡i bá» má»™t cÃ¡ch nhanh chÃ³ng, chá»‰ giá»¯ láº¡i má»™t sá»‘ cáº·p tiá»m nÄƒng Ä‘á»ƒ phÃ¢n tÃ­ch sÃ¢u hÆ¡n.
Má»™t thÆ°á»›c Ä‘o phá»• biáº¿n Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ *cointegration* lÃ  khoáº£ng cÃ¡ch giÃ¡ chuáº©n hÃ³a ***(Normalized Price Distance - NPD)***.

### 2. CÃ´ng thá»©c NPD:
```math
\text{NPD} = \sum_{t=1}^{T} \left( \tilde{p}_{1t} - \tilde{p}_{2t} \right)^2
```
**Trong Ä‘Ã³:**
- $$\tilde{p}_ {1t}$$ vÃ  $$\tilde{p}_{2t}$$ lÃ  giÃ¡ chuáº©n hÃ³a:
  
```math
  \tilde{p}_{1t} = \frac{p_{1t}}{p_{10}}, \quad \tilde{p}_{2t} = \frac{p_{2t}}{p_{20}}
```
  - $$p_{1t}, p_{2t}$$ lÃ  giÃ¡ gá»‘c cá»§a hai tÃ i sáº£n.
  - $$p_{10}, p_{20}$$ lÃ  giÃ¡ táº¡i thá»i Ä‘iá»ƒm ban Ä‘áº§u.

**Ã nghÄ©a:**
- NPD Ä‘o lÆ°á»ng sá»± khÃ¡c biá»‡t giá»¯a cÃ¡c giÃ¡ chuáº©n hÃ³a theo thá»i gian. Náº¿u NPD nhá», nghÄ©a lÃ  sá»± khÃ¡c biá»‡t giá»¯a cÃ¡c giÃ¡ chuáº©n hÃ³a á»•n Ä‘á»‹nh trong dÃ i háº¡n â†’ cáº·p tÃ i sáº£n cÃ³ tiá»m nÄƒng *cointegration*.

### 3. Prescreening vá»›i Log-Prices (giÃ¡ log):
Má»™t thÆ°á»›c Ä‘o tÆ°Æ¡ng tá»± cÅ©ng cÃ³ thá»ƒ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a vá»›i *log-prices* \( y_{1t} \) vÃ  \( y_{2t} \) báº±ng cÃ¡ch trá»« Ä‘i giÃ¡ trá»‹ táº¡i thá»i Ä‘iá»ƒm ban Ä‘áº§u:
```math
\tilde{y}_{1t} = y_{1t} - y_{10}, \quad \tilde{y}_{2t} = y_{2t} - y_{20}
```

- Chuá»—i $$\tilde{y}_ {1t}$$ vÃ  $$\tilde{y}_{2t}$$ Ä‘áº¡i diá»‡n cho sá»± khÃ¡c biá»‡t dÃ i háº¡n cá»§a chuá»—i giÃ¡ log (tÆ°Æ¡ng tá»± *log-returns*).

### 4. Ã nghÄ©a thá»±c táº¿:
- *Pre-screening* giÃºp nhanh chÃ³ng loáº¡i bá» nhá»¯ng cáº·p tÃ i sáº£n khÃ´ng cÃ³ tiá»m nÄƒng *cointegration* Ä‘á»ƒ táº­p trung phÃ¢n tÃ­ch ká»¹ hÆ¡n vÃ o cÃ¡c cáº·p cÃ³ giÃ¡ trá»‹ NPD nhá».
- Äiá»u nÃ y lÃ m giáº£m thá»i gian vÃ  chi phÃ­ tÃ­nh toÃ¡n khi thá»±c hiá»‡n chiáº¿n lÆ°á»£c *pairs trading* trÃªn nhiá»u cáº·p tÃ i sáº£n.

### TÃ³m táº¯t:
- *Prescreening* lÃ  bÆ°á»›c Ä‘áº§u tiÃªn trong quy trÃ¬nh tÃ¬m kiáº¿m cáº·p tÃ i sáº£n *cointegration* tiá»m nÄƒng.
- NPD Ä‘o lÆ°á»ng sá»± khÃ¡c biá»‡t giá»¯a cÃ¡c giÃ¡ chuáº©n hÃ³a theo thá»i gian. Náº¿u NPD tháº¥p, hai chuá»—i thá»i gian cÃ³ thá»ƒ cÃ³ má»‘i quan há»‡ *cointegration* máº¡nh.
- PhÆ°Æ¡ng phÃ¡p nÃ y cÅ©ng cÃ³ thá»ƒ Ã¡p dá»¥ng cho *log-prices* Ä‘á»ƒ Ä‘o lÆ°á»ng cÃ¡c biáº¿n Ä‘á»™ng dÃ i háº¡n cá»§a chuá»—i thá»i gian.

### VÃ­ dá»¥ code:
VÃ­ dá»¥ phÆ°Æ¡ng phÃ¡p **NPD** vÃ  **Log-Prices** vá»›i 1 list cÃ¡c pair vÃ­ dá»¥: pairs = ["EURUSD", "GBPUSD", "USDJPY", "AUDUSD", "USDCAD", "USDCHF", "NZDUSD"] (sá»­ dá»¥ng giÃ¡ [close] cho má»—i pair)
```python
# Reimport necessary libraries after the environment reset
import pandas as pd
import numpy as np
from itertools import combinations
import matplotlib.pyplot as plt

# Táº¡o chuá»—i dá»¯ liá»‡u giáº£ láº­p cho cÃ¡c cáº·p tiá»n tá»‡
np.random.seed(42)
T = 200  # Sá»‘ lÆ°á»£ng Ä‘iá»ƒm dá»¯ liá»‡u
pairs = ["EURUSD", "GBPUSD", "USDJPY", "AUDUSD", "USDCAD", "USDCHF", "NZDUSD"]
prices_data = {}

# Giáº£ láº­p dá»¯ liá»‡u giÃ¡ Ä‘Ã³ng cá»­a cho má»—i cáº·p tiá»n tá»‡
for pair in pairs:
    initial_price = np.random.uniform(1.0, 2.0)  # GiÃ¡ ban Ä‘áº§u ngáº«u nhiÃªn
    returns = np.random.normal(0, 0.01, T)  # Lá»£i nhuáº­n ngáº«u nhiÃªn
    prices_data[pair] = initial_price * np.exp(np.cumsum(returns))  # GiÃ¡ Ä‘Ã³ng cá»­a giáº£ láº­p

# Táº¡o DataFrame chá»©a giÃ¡ Ä‘Ã³ng cá»­a cá»§a táº¥t cáº£ cÃ¡c cáº·p tiá»n tá»‡
df_prices = pd.DataFrame(prices_data, index=pd.date_range(start='2022-01-01', periods=T))

# TÃ­nh toÃ¡n khoáº£ng cÃ¡ch giÃ¡ chuáº©n hÃ³a (NPD) cho tá»«ng cáº·p
npd_results = {}
for pair1, pair2 in combinations(pairs, 2):
    # GiÃ¡ chuáº©n hÃ³a
    norm_prices_1 = df_prices[pair1] / df_prices[pair1].iloc[0]
    norm_prices_2 = df_prices[pair2] / df_prices[pair2].iloc[0]
    # TÃ­nh NPD
    npd = np.sum((norm_prices_1 - norm_prices_2) ** 2)
    npd_results[(pair1, pair2)] = npd

# TÃ­nh toÃ¡n log-prices
log_prices = np.log(df_prices)

# TÃ­nh toÃ¡n khoáº£ng cÃ¡ch log-prices cho tá»«ng cáº·p
log_distance_results = {}
for pair1, pair2 in combinations(pairs, 2):
    shifted_log_1 = log_prices[pair1] - log_prices[pair1].iloc[0]
    shifted_log_2 = log_prices[pair2] - log_prices[pair2].iloc[0]
    log_distance = np.sum((shifted_log_1 - shifted_log_2) ** 2)
    log_distance_results[(pair1, pair2)] = log_distance

# Chuyá»ƒn káº¿t quáº£ thÃ nh DataFrame Ä‘á»ƒ dá»… quan sÃ¡t
npd_df = pd.DataFrame.from_dict(npd_results, orient='index', columns=['NPD'])
log_distance_df = pd.DataFrame.from_dict(log_distance_results, orient='index', columns=['Log-Price Distance'])

# Sáº¯p xáº¿p theo thá»© tá»± tÄƒng dáº§n
npd_df_sorted = npd_df.sort_values(by='NPD')
log_distance_df_sorted = log_distance_df.sort_values(by='Log-Price Distance')

# Hiá»ƒn thá»‹ káº¿t quáº£
print(npd_df_sorted,log_distance_df_sorted)
```
### Result
>(                       NPD
>(USDJPY, AUDUSD)  0.223389
>(USDJPY, NZDUSD)  0.476154
>(AUDUSD, NZDUSD)  0.690620
>(EURUSD, AUDUSD)  1.135016
>(EURUSD, USDJPY)  1.603391,
>                  Log-Price Distance
>(USDJPY, AUDUSD)            0.227109
>(USDJPY, NZDUSD)            0.512831
>(AUDUSD, NZDUSD)            0.763408
>(EURUSD, AUDUSD)            1.118013
>(EURUSD, USDJPY)            1.572460)

