# 1. Spread Modeling via Least Squares
Một thành phần chính trong giao dịch cặp là việc xây dựng một **spread hồi quy về trung bình**:

$$z_t = y_{1t} - \gamma y_{2t} = \mu + r_t$$

Trong đó:
- $$\gamma$$ là hệ số phòng hộ *(hedge ratio)*,
- $$\mu$$ là giá trị trung bình,
- $$r_t$$ là phần dư có giá trị trung bình bằng không.

Sau đó, chiến lược giao dịch sẽ định kích thước giao dịch dựa trên khoảng cách của spread $$z_t$$ so với giá trị cân bằng $$\mu$$.
Việc xây dựng spread đòi hỏi phải ước tính cẩn thận hệ số phòng hộ $$\gamma$$ cũng như giá trị trung bình của spread $$\mu$$. Phương pháp truyền thống để thực hiện điều này là sử dụng **hồi quy bình phương nhỏ nhất (least squares regression)**.

### Trong thực tế:
- Hệ số phòng hộ $$\gamma$$ và giá trị trung bình $$\mu$$ thường thay đổi từ từ theo thời gian.
- Do đó, nghiệm hồi quy bình phương nhỏ nhất cần được tính toán lại trên cơ sở cửa sổ trượt.

Tuy nhiên, sẽ tốt hơn nếu sử dụng các kỹ thuật mô hình hóa hiện đại để ước tính hiệu quả hơn, như:
- **Mô hình không gian trạng thái (state-space modeling)**,
- **Bộ lọc Kalman (Kalman filter)** nhằm thích nghi với sự thay đổi của thị trường (Chan, 2013; Feng and Palomar, 2016).

### Ý chính:
1. **Spread hồi quy về trung bình**:
   - Được định nghĩa bởi công thức $$z_t = y_{1t} - \gamma y_{2t}$$, trong đó:
     - $$r_t$$: phần dư, đại diện cho sự lệch khỏi trung bình $$\mu$$.

2. **Ước tính spread**:
   - Hồi quy bình phương nhỏ nhất được sử dụng để tính toán $$\gamma$$ và $$\mu$$.
   - Các giá trị này cần được cập nhật định kỳ trên cửa sổ trượt vì chúng thay đổi theo thời gian.

3. **Kỹ thuật hiện đại**:
   - **Bộ lọc Kalman** và **mô hình không gian trạng thái** cung cấp phương pháp linh hoạt hơn, cho phép thích ứng với sự biến động thị trường.
   - Đây là các công cụ tiên tiến để tối ưu hóa giao dịch cặp trong các điều kiện thay đổi.

### Phương pháp bình phương nhỏ nhất (least squares, LS)
Phương pháp bình phương nhỏ nhất được phát triển từ năm 1795 khi Gauss sử dụng nó để nghiên cứu chuyển động hành tinh. Phương pháp này xử lý mô hình tuyến tính $$y = A\alpha + \epsilon$$ bằng cách giải bài toán:

$$\text{minimize}_{\alpha} \| y - A\alpha \|_2^2$$

Nghiệm của bài toán này cung cấp ước lượng bình phương nhỏ nhất:

$$\hat{\alpha} = (A^\top A)^{-1}A^\top y$$

Thêm vào đó, ma trận hiệp phương sai của ước lượng $$\hat{\alpha}$$ được cho bởi:

$$\sigma^2 (A^\top A)^{-1}$$

trong đó $$\sigma^2$$ là phương sai của phần dư $$\epsilon$$ (trong thực tế, phương sai của phần dư ước lượng $$\epsilon = y - A\hat{\alpha}$$ cũng có thể được sử dụng).

### Trong ngữ cảnh của mô hình hóa spread
Chúng ta muốn phù hợp $$y_{1t} \approx \mu + \gamma y_{2t}$$ dựa trên $$T$$ quan sát, do đó công thức LS trở thành:

$$\text{minimize}_{\mu, \gamma} \| y_1 - (\mu 1 + \gamma y_2) \|_2^2$$

#### Trong đó:
- Các vector $$y_1$$ và $$y_2$$ chứa $$T$$ quan sát của hai chuỗi thời gian,
- $$1$$ là vector gồm toàn các phần tử bằng 1.

Giải pháp cung cấp ước lượng:

```math
\begin{bmatrix}
\hat{\mu} \\
\hat{\gamma}
\end{bmatrix}
=
\begin{bmatrix}
1^\top 1 & 1^\top y_2 \\
y_2^\top 1 & y_2^\top y_2
\end{bmatrix}^{-1}
\begin{bmatrix}
1^\top y_1 \\
y_2^\top y_1
\end{bmatrix}
```
### Trong thực tế:
- Thường thuận tiện hơn khi loại bỏ trung bình của $$y_1$$ và $$y_2$$ trước để tạo ra các phiên bản trung tâm của chúng:

$$\tilde{y}_1, \tilde{y}_2$$

- Sau đó ước lượng hệ số phòng hộ ($$\gamma$$):

$$\hat{\gamma} = \frac{\tilde{y}_1^\top \tilde{y}_2}{\tilde{y}_2^\top \tilde{y}_2}$$

- Và cuối cùng, tính trung bình mẫu của $$y_1 - \gamma y_2$$:

$$\hat{\mu} = \frac{1^\top (y_1 - \hat{\gamma} y_2)}{T}$$

Phương sai của các ước lượng này được cho bởi:

$$\text{Var}[\hat{\gamma}] = \frac{1}{T} \frac{\sigma^2}{\sigma_2^2}, \quad \text{Var}[\hat{\mu}] = \frac{1}{T} \sigma^2$$

#### Trong đó:
- $$\sigma_2^2$$ là phương sai của $$y_2$$,
- $$\sigma^2$$ là phương sai của phần dư $$\epsilon$$.

### Quan trọng:
- Trong thực tế, hệ số phòng hộ $$\gamma$$ và giá trị trung bình $$\mu$$ sẽ thay đổi dần theo thời gian. Do đó:
  - Lời giải bình phương nhỏ nhất cần được tính toán lại trên cơ sở cửa sổ trượt (dựa trên dữ liệu quan sát trước đó).
  - Tuy nhiên, các trường hợp biến đổi theo thời gian này được xử lý tốt hơn bằng cách sử dụng Bộ lọc Kalman, như đã mô tả trong các phần sau.

### Ý chính:
1. **Phương pháp bình phương nhỏ nhất (LS):**
   - Giải quyết bài toán hồi quy để ước lượng các tham số $$\mu$$ và $$\gamma$$.
   - Tính toán dựa trên việc tối thiểu hóa sai số phần dư.

2. **Ứng dụng trong giao dịch cặp:**
   - Loại bỏ trung bình của $$y_1$$ và $$y_2$$ để ước lượng $$\gamma$$.
   - Tính toán $$\mu$$ dựa trên phần còn lại.

3. **Cập nhật trong thực tế:**
   - $$\gamma$$ và $$\mu$$ cần được cập nhật định kỳ do chúng thay đổi theo thời gian.
   - Bộ lọc Kalman là công cụ phù hợp hơn để xử lý các thay đổi động này.

# Primer on the Kalman Filter
Mô hình không gian trạng thái và Bộ lọc Kalman

Mô hình không gian trạng thái (State-space modeling) cung cấp một khung thống nhất để xử lý nhiều loại vấn đề trong phân tích chuỗi thời gian. Nó có thể được coi là một mô hình phổ quát và linh hoạt, với một thuật toán rất hiệu quả là bộ lọc Kalman (Kalman filter). Ý tưởng cơ bản là ước tính sự tiến hóa của hệ thống theo thời gian, được thúc đẩy bởi một loạt các giá trị chưa quan sát hoặc giá trị ẩn, mà chỉ có thể được đo lường gián tiếp thông qua các quan sát từ đầu ra của hệ thống. Mô hình này có thể được sử dụng để lọc, làm mượt và dự báo. Chi tiết hơn về mô hình không gian trạng thái và bộ lọc Kalman có thể được tìm thấy trong Mục 4.2 của Chương 4.
Bộ lọc Kalman, được NASA sử dụng trong chương trình Apollo vào những năm 1960, hiện nay đã có rất nhiều ứng dụng công nghệ. Nó thường được sử dụng trong dẫn đường, định vị và điều khiển của các phương tiện như máy bay, tàu vũ trụ và tàu biển. Bộ lọc này cũng được ứng dụng rộng rãi trong phân tích chuỗi thời gian, xử lý tín hiệu và kinh tế lượng. Gần đây, nó đã trở thành một thành phần chính trong việc lập kế hoạch và kiểm soát robot, cũng như tối ưu hóa quỹ đạo.
Mô hình không gian trạng thái và bộ lọc Kalman đã trưởng thành, với nhiều sách giáo khoa xuất sắc có sẵn như các tài liệu kinh điển của B. D. O. Anderson và Moore (1979), Durbin và Koopman (2012). Một số tài liệu tham khảo khác bao gồm Brockwell và Davis (2002), Shumway và Stoffer (2017), A. Harvey (1989), và đặc biệt trong chuỗi thời gian tài chính như Zivot et al. (2004), Tsay (2010), Lütkepohl (2007), và Koopman (2009).**

### Mô hình toán học của Bộ lọc Kalman
Về mặt toán học, bộ lọc Kalman dựa trên mô hình không gian trạng thái tuyến tính Gaussian với thời gian rời rạc $$t = 1, \dots, T$$ (Durbin và Koopman, 2012):

$$y_t = Z_t \alpha_t + \epsilon_t \quad (\text{phương trình quan sát}),$$

$$\alpha_{t+1} = T_t \alpha_t + \eta_t \quad (\text{phương trình trạng thái}),$$

#### Trong đó:
- $$y_t$$: Quan sát qua thời gian.
- $$Z_t$$: Ma trận quan sát.
- $$\alpha_t$$: Trạng thái ẩn hoặc chưa quan sát được của hệ thống.
- $$T_t$$: Ma trận chuyển tiếp trạng thái.
- $$\epsilon_t$$ và $$\eta_t$$: Các nhiễu Gaussian với giá trị trung bình bằng 0 và ma trận hiệp phương sai lần lượt là $$H$$ và $$Q$$:

$$\epsilon_t \sim \mathcal{N}(0, H), \quad \eta_t \sim \mathcal{N}(0, Q).$$

- Trạng thái ban đầu $$\alpha_1$$ có thể được mô hình hóa như:

$$\alpha_1 \sim \mathcal{N}(\alpha_1, P_1).$$

#### Ghi chú:
- Các tham số của mô hình không gian trạng thái ($$Z_t, T_t, H, Q, \alpha_1, P_1$$) có thể được người dùng cung cấp (nếu biết) hoặc được suy ra từ dữ liệu với các thuật toán tối đa hóa độ khả năng hợp lý (maximum likelihood estimation).

### Ý nghĩa và ứng dụng của Bộ lọc Kalman:
1. **Tối ưu hóa phân phối trạng thái ẩn:**
   - Bộ lọc Kalman là một thuật toán hiệu quả để mô tả tối ưu phân phối của trạng thái ẩn tại thời điểm $$t$$, $$\alpha_t$$, theo cách nhân quả.
   - Cụ thể:
     - $$\alpha_{t+1|t}$$: Trạng thái dự đoán tại thời điểm $$t + 1$$ dựa trên các quan sát từ $$t$$ trở về trước.
     - $$\alpha_{t|t}$$: Trạng thái ước tính tại thời điểm $$t$$.
   - Các giá trị này có thể được tính toán hiệu quả thông qua quy trình "đi tới" (forward pass) từ $$t = 1$$ đến $$T$$.

2. **Ứng dụng thực tế:**
   - Bộ lọc Kalman không chỉ được sử dụng trong mô hình hóa chuỗi thời gian mà còn trong các bài toán điều khiển thời gian thực.

### Kết luận:
- **Mô hình không gian trạng thái** cung cấp một cách tiếp cận linh hoạt để xử lý chuỗi thời gian phức tạp.
- Bộ lọc Kalman là một công cụ mạnh mẽ và hiệu quả để ước tính trạng thái ẩn của hệ thống, đặc biệt trong các ứng dụng thời gian thực như tài chính, kinh tế lượng, và kỹ thuật điều khiển.

# Spread Modeling via Kalman
### Mô hình không gian trạng thái cho Spread

Trong bối cảnh mô hình hóa spread, chúng ta muốn mô hình hóa $$y_{1t} \approx \mu_t + \gamma_t y_{2t}$$, trong đó $$\mu$$ và $$\gamma$$ thay đổi chậm theo thời gian. Điều này có thể thực hiện dễ dàng thông qua mô hình không gian trạng thái bằng cách xác định trạng thái ẩn là $$\alpha_t = (\mu_t, \gamma_t)$$, dẫn đến:

```math
y_{1t} = [1 \ y_{2t}] 
\begin{bmatrix}
\mu_t \\
\gamma_t
\end{bmatrix} 
+ \epsilon_t,
```

```math
\begin{bmatrix}
\mu_{t+1} \\
\gamma_{t+1}
\end{bmatrix} 
= 
\begin{bmatrix}
1 & 0 \\
0 & 1
\end{bmatrix}
\begin{bmatrix}
\mu_t \\
\gamma_t
\end{bmatrix} 
+ 
\begin{bmatrix}
\eta_{\mu_t} \\
\eta_{\gamma_t}
\end{bmatrix},
```

Trong đó:
- Tất cả các thành phần nhiễu đều độc lập và tuân theo phân phối:

  - $$\epsilon_t \sim \mathcal{N}(0, \sigma_\epsilon^2),$$

  - $$\eta_{\mu_t} \sim \mathcal{N}(0, \sigma_\mu^2),$$

  - $$\eta_{\gamma_t} \sim \mathcal{N}(0, \sigma_\gamma^2).$$

- Ma trận chuyển tiếp trạng thái là $$T = I$$, ma trận quan sát là $$Z_t = [1 \ y_{2t}]$$, và trạng thái ban đầu là:

  - $$\mu_1 \sim \mathcal{N}(\bar{\mu}_ 1, \sigma_{\mu_1}^2),$$
    
  - $$\gamma_1 \sim \mathcal{N}(\bar{\gamma}_ 1, \sigma_{\gamma_1}^2)$$.

### Spread Chuẩn hóa
Với đơn bày = 1 (xem công thức 15.2), spread chuẩn hóa có thể được tính:

$$z_t = \frac{1}{1 + \gamma_{t-1}} \left( y_{1t} - \gamma_{t-1} y_{2t} - \mu_{t-1} \right),$$

Trong đó $$\mu_{t-1}$$ và $$\gamma_{t-1}$$ là các trạng thái ẩn được ước tính bởi thuật toán Kalman.

### Ước tính các Tham số của Mô hình
Các tham số của mô hình không gian trạng thái ($$\sigma_\epsilon^2, \sigma_\mu^2, \sigma_\gamma^2$$) có thể được xác định bằng cách:

1. **Heuristic đơn giản:**
- Sử dụng dữ liệu huấn luyện $$T^{LS}$$ mẫu để ước tính $$\mu$$ và $$\gamma$$ thông qua bình phương nhỏ nhất (LS).
- Tính toán phần dư của $$LS_t$$, sau đó xác định tham số của mô hình:

   - $\sigma_\epsilon^2 = Var[ \epsilon_t ],$

   - $\mu_1 \sim \mathcal{N}(\mu_{\mu}, \sigma_{\mu}^2),$

   - $\gamma_1 \sim \mathcal{N}(\gamma_{\gamma}, \sigma_{\gamma}^2).$

2. **Tham số $$\alpha$$:**
- Xác định tỷ lệ biến động của các trạng thái ẩn thay đổi chậm so với biến động của spread.

### Mở Rộng Mô Hình Không Gian Trạng Thái
1. **Thêm Thành phần Vận tốc:**
   - Mô hình không chỉ xét đến hệ số phòng hộ $$\gamma_t$$ mà còn cả tốc độ thay đổi $$\dot{\gamma}_t$$:
   
$$\alpha_t = (\mu_t, \gamma_t, \dot{\gamma}_t),$$

dẫn đến:

```math
     \begin{bmatrix}
     \mu_{t+1} \\
     \gamma_{t+1} \\
     \dot{\gamma}_{t+1}
     \end{bmatrix}
     =
     \begin{bmatrix}
     1 & 0 & 0 \\
     0 & 1 & 1 \\
     0 & 0 & 1
     \end{bmatrix}
     \begin{bmatrix}
     \mu_t \\
     \gamma_t \\
     \dot{\gamma}_t
     \end{bmatrix}
     +
     \eta_t.
```

3. **Thành phần Tự hồi quy:**
   - Dưới khái niệm cointegration từng phần, mô hình spread với thành phần tự hồi quy được mở rộng:

$$\alpha_t = (\mu_t, \gamma_t, \epsilon_t),$$

dẫn đến:

```math
     \begin{bmatrix}
     \mu_{t+1} \\
     \gamma_{t+1} \\
     \epsilon_{t+1}
     \end{bmatrix}
     =
     \begin{bmatrix}
     1 & 0 & 0 \\
     0 & 1 & 0 \\
     0 & 0 & \rho
     \end{bmatrix}
     \begin{bmatrix}
     \mu_t \\
     \gamma_t \\
     \epsilon_t
     \end{bmatrix}
     +
     \eta_t,
```
 
trong đó $$|\rho| < 1$$ hoặc $$\rho$$ cố định ở giá trị hợp lý như $$\rho = 0.9$$.

### Kết luận
- Mô hình không gian trạng thái cung cấp một phương pháp linh hoạt và hiệu quả để mô hình hóa spread trong giao dịch cặp.
- Việc mở rộng mô hình với vận tốc hoặc thành phần tự hồi quy có thể cải thiện đáng kể hiệu suất dự báo và giao dịch.


